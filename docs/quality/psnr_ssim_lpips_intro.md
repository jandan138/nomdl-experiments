# 图像质量指标新手入门：PSNR / SSIM / LPIPS

本文面向零基础读者，通俗讲清楚三个常用的图像质量与相似度指标：PSNR、SSIM、LPIPS。读完你将知道它们分别代表什么、数值怎么理解、各自的优缺点，以及在本项目中如何使用它们。

## 为什么需要这些指标

- 我们常要比较两张图片：一张是“参考”（原图），另一张是“对比”（经过处理、渲染或压缩后的图）。
- 目标是回答两个问题：
  - 它们在“像素层面”的差异有多大？
  - 它们在“人眼感知”的层面看起来像不像？
- PSNR 更偏像素误差；SSIM 更偏结构（局部对比度、纹理）；LPIPS 更贴近人眼感知（基于深度特征）。

## 快速结论（先有直觉）

- PSNR：越高越好。衡量像素误差的“分贝”强度，常见阈值是 30 dB 以上较好，40 dB 非常好。
- SSIM：范围 0~1，越接近 1 越好。衡量亮度、对比度与结构的相似度，比 PSNR 更贴近视觉感受。
- LPIPS：范围通常在 0~1，越接近 0 越好。是“学习的感知距离”，最接近人类主观的“看起来像不像”。

## 基本概念与前置知识

- 两张图片对比通常假设“大小、对齐、颜色空间”一致。若不一致，指标可能会被误导。
- 8 位图（每通道 0~255）是最常见情况；若是 16 位或浮点图，需先统一到同一值域再计算。

## PSNR（Peak Signal-to-Noise Ratio）

### 通俗解释

- 把“原图”视作信号，把“对比图与原图的差”视作噪声。PSNR 就是信号与噪声的比值（取对数后的分贝 dB 表示）。噪声越小，PSNR 越高。

### 简单公式（帮助建立直觉）

- `MSE` 是两图像像素差的均方误差；`MAX` 是像素最大值（8 位图通常是 255）。
- `PSNR = 10 * log10( MAX^2 / MSE )`
- 当两图完全相同时，`MSE=0`，PSNR 趋近无穷大（实际实现中会做极值保护）。

### 如何读数

- 30 dB：在许多压缩场景下被认为“质量不错”。
- 40 dB 以上：通常非常好，肉眼很难看出差异。
- 要注意：PSNR 对小的几何位移、轻微的模糊等不敏感于“视觉感受”，它只看像素差。

### 常见坑

- 值域不一致：比如一张是 [0,1] 浮点，一张是 [0,255] 整数，必须统一后再算。
- 颜色空间：最好在同一颜色空间下比较（通常是 sRGB）。
- 对齐问题：有 1 像素的平移就会明显降低 PSNR。

## SSIM（Structural Similarity Index）

### 通俗解释

- SSIM 从三个维度比较两张图的“局部块”：亮度（luminance）、对比度（contrast）与结构（structure）。
- 它用滑动窗口在整图上计算并平均，结果在 0~1 之间，越接近 1 表示越相似。

### 优势

- 比单纯像素误差更符合视觉：结构、纹理相似时 SSIM 保持高分。
- 对轻微亮度与对比度变化有一定容忍度。

### 局限

- 对明显的几何变形（缩放、旋转、平移）仍然较敏感。
- 极端的颜色风格变化可能让 SSIM 降低，但人眼主观上仍觉得“像”。

## LPIPS（Learned Perceptual Image Patch Similarity）

### 通俗解释

- LPIPS 用预训练的深度网络（如 VGG/AlexNet/SqueezeNet）的多层特征来衡量两张图的“感知差异”。
- 想象把图像“投影”到一组能捕捉纹理、形状、语义的高维特征空间，在这个空间里测量距离。距离越小越“看起来像”。

### 数值与模型变体

- 输出通常在 0~1 范围（实现不同可能略有差异），越接近 0 越相似。
- 可选不同主干网络（VGG 等），数值在不同主干之间不可直接横向比较，但相对变化趋势可靠。

### 优势

- 最贴近人类主观感知：对纹理、语义保持更敏感，对微小像素误差更宽容。

### 局限

- 计算比 PSNR/SSIM 更慢，需要深度网络支持。
- 对极端风格迁移、强语义变化时，数值解读需结合具体任务背景。

## 该用哪个指标？（选择建议）

- 压缩、编解码质量评估：先看 PSNR（简单、快速）；再结合 SSIM。
- 图像还原/去噪/超分辨：SSIM 常更有参考意义；配合 LPIPS 判断是否“看起来更像”。
- 贴近人眼的主观相似度：重点看 LPIPS，并用 SSIM 辅助。
- 最稳妥的做法：联合使用三者，从像素、结构、感知三个维度交叉验证。

## 在本项目中如何使用

- 运行命令：

```powershell
python -m src.image_quality
```

- 输出文件：
  - `outputs/tables/image_quality_metrics.csv`：每对图的 PSNR/SSIM/LPIPS 指标。
  - `outputs/tables/image_quality_summary.csv`：总体均值与标准差。
  - `outputs/figures/image_quality_side_by_side.png`：10 对左右拼图，便于直观对比。

- 若目录结构是多级子文件夹且两侧相对路径一致，可参考 `docs/quality/compare_folders.md` 使用批量对比脚本。

## 例子（帮助建立直觉）

- 情况 1：两图几乎完全相同，但有 1 像素的平移。
  - PSNR：会明显下降（像素误差增加）。
  - SSIM：也会下降（结构对齐被破坏）。
  - LPIPS：可能仍较低（视觉上整体看起来差不多）。

- 情况 2：对比图整体亮度略高、颜色稍偏，但纹理和形状一致。
  - PSNR：可能一般（像素有差）。
  - SSIM：较高（结构与对比度仍相似）。
  - LPIPS：较低（感知上仍很像）。

## 实用建议与最佳实践

- 统一值域与颜色空间后再计算（如全部转为 `uint8` 的 sRGB）。
- 对齐与尺寸一致很重要，必要时做裁剪或重采样以匹配。
- 关注“趋势”而非单个绝对值，尤其是跨数据集或跨模型比较。
- 用多指标联合判断，避免被单一指标的局限误导结论。

## FAQ

- 为什么 PSNR 很高但我仍能看出差异？
  - PSNR只看像素误差，对颜色风格或细微视觉差别不敏感。结合 SSIM/LPIPS 观察。

- SSIM 为何不够 1？
  - 真实世界存在噪声、亮度差、重采样差异，结构块也会略有差别，难以达到完美一致。

- LPIPS 计算很慢怎么办？
  - 可以抽样计算或只用于关键样本分析；批量场景下结合 PSNR/SSIM 做初筛。

## 术语小抄

- PSNR：峰值信噪比，越高越好，偏像素误差。
- SSIM：结构相似度，0~1 越高越好，偏局部结构与对比度。
- LPIPS：学习的感知距离，0~1 越低越好，偏人眼主观相似度。

## 一步步算一个 PSNR 例子（手算）

- 假设两张 2×2 的灰度图（8 位，0~255）：
  - 原图 A：[[100, 120], [130, 140]]
  - 对比图 B：[[98, 121], [131, 139]]
- 差值矩阵 B−A：[[-2, +1], [+1, -1]]
- 平方：[[4, 1], [1, 1]]，总和=7
- MSE：7 / 4 = 1.75
- MAX=255，PSNR=10·log10(255² / 1.75)≈10·log10(37157.14)≈45.7 dB
- 结论：45.7 dB 属于很高的相似度，肉眼几乎看不出差别。

## 一步步算一个 SSIM 例子（手算）

- 用同样的 2×2 小块，取整块为一个窗口：
  - A 的均值 µx = (100+120+130+140)/4 = 122.5
  - B 的均值 µy = (98+121+131+139)/4 = 122.25
  - A 的方差 σx² = [(100−122.5)²+(120−122.5)²+(130−122.5)²+(140−122.5)²]/4
    = (506.25+6.25+56.25+306.25)/4 = 218.75
  - B 的方差 σy² = [(98−122.25)²+(121−122.25)²+(131−122.25)²+(139−122.25)²]/4
    = (588.06+1.56+76.56+280.56)/4 ≈ 236.69
  - 协方差 σxy = [∑(x−µx)(y−µy)]/4 ≈ 226.88
- 常用常数：L=255，K1=0.01，K2=0.03 → C1=(K1·L)²≈6.50，C2=(K2·L)²≈58.52
- SSIM = [(2µxµy+C1)(2σxy+C2)] / [(µx²+µy²+C1)(σx²+σy²+C2)]
- 代入得到 SSIM ≈ 0.997（非常相似）

## LPIPS 计算流程示例（理解思路）

- 思路：用深度网络的多层特征比较两图的“感知差异”，输出一个距离值。
- 步骤：
  - 把两图统一到相同大小与颜色空间；
  - 标准化到模型需要的张量范围；
  - 送入 LPIPS 模型，得到 0~1 左右的距离；
  - 距离越小，感知上越相似。
- Python 示例（需安装 `torch` 和 `lpips`）：

```python
import torch
import lpips
from PIL import Image
import torchvision.transforms as T

net = lpips.LPIPS(net='vgg').eval()

to_tensor = T.Compose([
    T.Resize((256, 256)),
    T.ToTensor(),                 # [0,1]
    T.Normalize([0.5,0.5,0.5],[0.5,0.5,0.5])  # [-1,1]
])

def load(path):
    img = Image.open(path).convert('RGB')
    x = to_tensor(img).unsqueeze(0)  # NCHW
    return x

x = load('A.png')
y = load('B.png')
d = net(x, y)
print(float(d))
```

## 彩色图如何计算（多通道处理）

- PSNR：通常对 RGB 的每个通道分别算 MSE，再取平均；也可先转到 Y 通道（亮度）后计算。
- SSIM：对每个通道计算再平均，或对亮度通道计算；多尺度 SSIM（MS-SSIM）效果更稳健。
- LPIPS：直接对三通道 RGB 输入，模型内部处理特征。

## 指标对比与使用场景

- PSNR：像素差异敏感，快速、简单；适合编解码与还原任务的基准比较。
- SSIM：结构与局部对比度敏感，更贴近人眼；适合恢复类任务的质量评估。
- LPIPS：语义与纹理感知更强，贴近主观感受；适合风格、重建类效果的最终对比。

## 常见误区与对策

- 仅看单一指标：容易误判。应联合三者，交叉验证结论。
- 值域/颜色空间混乱：务必统一到同一范围与空间。
- 尺寸/对齐不一致：先做重采样与对齐，再计算。
- 超小样本推断全局结论：尽量批量统计，关注均值与分布。

## 更贴近实践的示例场景

- 场景 A（轻微模糊）：PSNR 可能不低，SSIM 明显下降，LPIPS 也可能偏高。
- 场景 B（整体亮度偏移）：PSNR 一般，SSIM 较高，LPIPS 较低。
- 场景 C（纹理改变但结构不变）：PSNR 一般，SSIM 尚可，LPIPS 较高。

## 在代码里快速计算（参考）

- PSNR 与 SSIM 可以用 `scikit-image`：

```python
from skimage.metrics import peak_signal_noise_ratio, structural_similarity
import numpy as np

img_a = ...  # HxW or HxWxC, uint8 or float
img_b = ...

psnr = peak_signal_noise_ratio(img_a, img_b, data_range=255)
ssim = structural_similarity(img_a, img_b, channel_axis=-1)
```

- LPIPS 用上面的 `lpips` 示例即可。

## 如何解读项目输出

- `image_quality_metrics.csv`：逐对图的 PSNR/SSIM/LPIPS，便于发现异常样本。
- `image_quality_summary.csv`：全局均值与标准差，支持横向比较不同数据集或方法。
- `image_quality_side_by_side.png`：挑选样本的视觉对比，配合数值更可靠。

## 结论与建议

- 在工程中，优先保证输入对齐与规范化，再计算指标。
- 报告时同时给出三者与可视化示例，避免只用单一数值。
- 如果结论分歧，优先用 LPIPS 与人眼视觉检查做最终裁决，PSNR/SSIM 提供量化佐证。

